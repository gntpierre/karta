<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeighborScore - V9.5 (Ultimate)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet & Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Pako for GZIP Decompression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
        
        #autocomplete-list {
            position: absolute; z-index: 50; top: 100%; left: 0; right: 0;
            background: white; border: 1px solid #e2e8f0; border-radius: 0.5rem;
            max-height: 200px; overflow-y: auto; display: none;
        }
        .suggestion-item { padding: 0.75rem 1rem; cursor: pointer; }
        .suggestion-item:hover { background-color: #f1f5f9; }

        .loader-dot {
            width: 12px; height: 12px; background-color: #3b82f6; border-radius: 50%;
            display: inline-block; animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        /* Popups Map */
        .leaflet-popup-content-wrapper { border-radius: 0.5rem; padding: 0; overflow: hidden; }
        .leaflet-popup-content { margin: 0; width: 200px !important; }
        .popup-header { padding: 8px 12px; color: white; font-weight: bold; font-size: 0.85rem; }
        .popup-body { padding: 10px 12px; font-size: 0.8rem; color: #475569; }

        /* Glassmorphism Card */
        .glass-card {
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        /* Bar Chart Animation */
        .bar-anim { height: 0; transition: height 1s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* ADMIN PANEL STYLES */
        .admin-trigger { cursor: help; user-select: none; }
        #admin-panel {
            position: fixed; bottom: 20px; right: 20px; z-index: 9999;
            background: #1e293b; color: white; padding: 1rem; border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5);
            width: 320px; transform: translateY(150%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        #admin-panel.open { transform: translateY(0); }
        .pulsing-badge { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden relative">

    <!-- LANDING PAGE -->
    <div id="landing-page" class="absolute inset-0 z-40 flex flex-col justify-center items-center bg-slate-900 text-white p-6 transition-transform duration-500">
        <div class="max-w-4xl w-full text-center slide-up">
            <!-- SECRET TRIGGER: Click 5 times on this badge -->
            <div id="secret-trigger" onclick="handleSecretClick()" class="admin-trigger inline-block bg-indigo-500/20 text-indigo-300 px-4 py-1 rounded-full text-xs font-semibold mb-6 border border-indigo-500/30 uppercase tracking-wide cursor-pointer transition-all hover:bg-indigo-500/40">
                <i class="fa-solid fa-chart-pie mr-1"></i> Market V9.5
            </div>
            
            <h1 class="text-4xl md:text-6xl font-bold mb-6 tracking-tight">
                L'analyse immobilière <br> <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">basée sur la donnée réelle.</span>
            </h1>
            
            <div class="relative max-w-lg mx-auto">
                <div class="flex items-center bg-white rounded-xl shadow-2xl p-2 transition-all focus-within:ring-4 ring-indigo-500/30">
                    <i class="fa-solid fa-search text-slate-400 ml-3 text-lg"></i>
                    <input type="text" id="address-input" 
                           class="w-full bg-transparent border-none focus:ring-0 text-slate-800 placeholder-slate-400 px-4 py-3 outline-none" 
                           placeholder="Entrez une adresse..." autocomplete="off">
                    <button onclick="startAnalysis()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors">
                        Scanner
                    </button>
                </div>
                <div id="autocomplete-list" class="text-left text-slate-700 mt-2 shadow-xl border-t border-slate-100"></div>
                
                <!-- Status message if global data is loaded -->
                <div id="db-status-msg" class="hidden mt-6 flex items-center justify-center gap-2 text-emerald-400 text-xs font-mono bg-emerald-900/30 py-2 px-4 rounded border border-emerald-500/30">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span id="db-count-display">CHARGEMENT BDD...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ADMIN PANEL (Hidden by default) -->
    <div id="admin-panel">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-bold text-white"><i class="fa-solid fa-database mr-2"></i>Gestion Données</h3>
            <button onclick="closeAdmin()" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
        </div>
        
        <div class="bg-slate-800 p-3 rounded-lg mb-4 border border-slate-700">
            <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Ajouter des Données (Cumulatif)</p>
            <p class="text-xs text-slate-300 mb-3">Chargez plusieurs fichiers .csv/.gz. Ils seront sauvegardés.</p>
            
            <label id="admin-upload-btn" class="block w-full cursor-pointer bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-2 px-3 rounded text-center transition-colors">
                <i class="fa-solid fa-plus-circle mr-1"></i> AJOUTER FICHIER
                <input type="file" id="admin-csv-upload" accept=".csv, .txt, .gz" class="hidden" multiple onchange="handleBatchUpload(this.files)">
            </label>
        </div>

        <div id="admin-stats" class="text-xs text-slate-400 space-y-2">
            <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                <span>Total en base:</span> 
                <span id="stat-total-lines" class="text-emerald-400 font-bold text-sm">0</span>
            </div>
            
            <button onclick="clearDatabase()" class="w-full text-center text-red-400 hover:text-red-300 text-[10px] uppercase font-bold py-1 border border-red-900/50 rounded bg-red-900/20 hover:bg-red-900/40 transition-colors">
                <i class="fa-solid fa-trash mr-1"></i> Tout supprimer
            </button>
            
            <div class="mt-2 text-[10px] text-slate-500 italic" id="stat-debug">
                Prêt.
            </div>
        </div>
    </div>

    <!-- LOADING SCREEN -->
    <div id="loading-screen" class="absolute inset-0 z-30 bg-white flex flex-col justify-center items-center hidden">
        <div id="loading-content" class="text-center w-80">
            <div class="mb-8 flex gap-3 justify-center">
                <div class="loader-dot bg-blue-500"></div><div class="loader-dot bg-indigo-500"></div><div class="loader-dot bg-purple-500"></div>
            </div>
            <h2 class="text-xl font-bold text-slate-800 mb-2">Audit en cours</h2>
            <p class="text-sm text-slate-500 mb-8" id="loading-text">Analyse des données...</p>
            
            <div class="space-y-3 text-left">
                <div class="flex items-center gap-3 text-sm text-slate-400" id="step-1"><i class="fa-solid fa-circle-notch fa-spin" id="icon-1"></i> Infrastructure (OpenStreetMap)</div>
                <div class="flex items-center gap-3 text-sm text-slate-400" id="step-2"><i class="fa-regular fa-circle" id="icon-2"></i> Base de Données Locale</div>
                <div class="flex items-center gap-3 text-sm text-slate-400" id="step-3"><i class="fa-regular fa-circle" id="icon-3"></i> Consolidation</div>
            </div>
        </div>
        
        <div id="error-content" class="hidden text-center max-w-md p-6">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4"><i class="fa-solid fa-triangle-exclamation text-red-500 text-2xl"></i></div>
            <h3 class="text-xl font-bold text-slate-800 mb-2">Données Introuvables</h3>
            <p class="text-slate-500 mb-4 text-sm" id="error-message">Aucune donnée trouvée.</p>
            
            <div class="bg-amber-50 border border-amber-200 p-3 rounded text-left mb-6" id="local-data-hint">
                <p class="text-xs text-amber-800 font-bold mb-1"><i class="fa-solid fa-database"></i> Base Locale</p>
                <p class="text-xs text-amber-700">Votre base contient <span id="hint-count">0</span> lignes, mais aucune ne correspond à cette adresse (même avec rayon étendu à 5km).</p>
            </div>

            <button onclick="retryAnalysis()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm hover:bg-indigo-700">Réessayer</button>
            <button onclick="resetApp()" class="block w-full text-sm text-slate-400 mt-4 hover:text-slate-600">Annuler</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="h-full flex hidden opacity-0 transition-opacity duration-1000">
        <div class="w-full md:w-6/12 h-full relative p-3">
            <div id="map"></div>
            <div class="absolute top-5 left-5 right-5 z-[500] pointer-events-none flex justify-between">
                <div class="bg-white/95 backdrop-blur px-5 py-3 rounded-xl shadow-lg border border-slate-200 pointer-events-auto max-w-md">
                    <h3 class="font-bold text-slate-800 truncate" id="result-address">Adresse</h3>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-[10px] font-black bg-slate-800 text-white px-2 py-0.5 rounded uppercase" id="typology-badge">--</span>
                        <span class="text-xs text-slate-500 font-medium" id="typology-desc">...</span>
                        <span class="text-[9px] bg-slate-200 text-slate-500 px-1 rounded ml-1" id="radius-badge">500m</span>
                    </div>
                </div>
            </div>
            <div class="absolute bottom-6 left-6 z-[500] bg-white/95 backdrop-blur p-3 rounded-xl shadow-lg border border-slate-100 text-xs font-medium space-y-2 pointer-events-auto">
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Transports</div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-amber-400"></span> Commerces</div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> Éducation</div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-rose-500"></span> Santé</div>
                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-purple-600 border border-white"></span> Vente Immo Récente</div>
            </div>
        </div>

        <div class="w-full md:w-6/12 h-full bg-white border-l border-slate-200 overflow-y-auto p-6 md:p-8 flex flex-col">
            
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Rapport de Zone</h2>
                <button onclick="resetApp()" class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-2 rounded-lg hover:bg-indigo-100 transition-colors">
                    <i class="fa-solid fa-arrow-rotate-left mr-1"></i> NOUVEAU
                </button>
            </div>

            <!-- ULTIMATE PRICE CARD -->
            <div class="glass-card rounded-2xl p-6 text-white mb-8 relative overflow-hidden" style="min-height: 240px;">
                <!-- Decorative Glows -->
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-indigo-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse"></div>
                <div class="absolute -bottom-10 -left-10 w-40 h-40 bg-emerald-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-pulse" style="animation-delay: 1s;"></div>
                
                <div class="flex items-center justify-between mb-8 relative z-10">
                    <h3 class="text-xs font-bold text-indigo-200 uppercase tracking-widest border-b border-indigo-500/30 pb-1">
                        <i class="fa-solid fa-chart-line mr-2"></i>Analyse de Marché
                    </h3>
                    <span id="data-source-badge" class="text-[9px] px-2 py-0.5 rounded bg-slate-800/50 border border-slate-600 text-slate-400">Source: --</span>
                </div>
                
                <div class="flex flex-col md:flex-row gap-8 relative z-10">
                    <!-- LEFT COL: GLOBAL PRICE -->
                    <div class="flex-1 flex flex-col justify-center">
                        <p class="text-[10px] text-slate-400 mb-1 uppercase tracking-wide">Prix Moyen Constaté / m²</p>
                        <div class="flex items-baseline gap-2">
                            <span class="text-5xl lg:text-6xl font-black text-transparent bg-clip-text bg-gradient-to-br from-white via-white to-slate-400 tracking-tighter" id="price-global">---</span>
                            <span class="text-xl text-slate-500 font-light">€</span>
                        </div>
                        <p class="text-[10px] text-slate-400 mt-2 opacity-80" id="data-meta-info">Analyse sur 24 mois</p>
                    </div>
                    
                    <!-- RIGHT COL: HISTORY & VISUALS -->
                    <div class="flex-1 flex flex-col justify-end border-t md:border-t-0 md:border-l border-slate-700/50 pt-4 md:pt-0 md:pl-6">
                        <!-- Mini Bar Chart -->
                        <div class="h-16 flex items-end gap-2 mb-2 px-1 relative">
                            <!-- Baseline -->
                            <div class="absolute bottom-0 left-0 right-0 h-px bg-slate-700/50"></div>
                            <!-- Bars Container -->
                            <div id="trend-bars" class="w-full flex items-end gap-3 h-full"></div>
                        </div>

                        <!-- Legend/Trend Text -->
                        <div id="trend-summary" class="flex justify-between items-center text-xs">
                            <span class="text-slate-500 italic">Historique</span>
                            <span class="text-white font-bold">---</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex items-center justify-between mb-8 bg-slate-50 p-4 rounded-2xl border border-slate-100 shadow-sm">
                <div>
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Score Quartier</div>
                    <h2 class="text-2xl font-bold text-slate-800" id="global-label">--</h2>
                </div>
                <div class="relative w-16 h-16 flex items-center justify-center">
                    <svg class="transform -rotate-90 w-16 h-16">
                        <circle cx="32" cy="32" r="28" stroke="#cbd5e1" stroke-width="6" fill="transparent" />
                        <circle id="global-score-circle" cx="32" cy="32" r="28" stroke="#4f46e5" stroke-width="6" fill="transparent" stroke-dasharray="175" stroke-dashoffset="175" class="transition-all duration-1000 ease-out" />
                    </svg>
                    <span class="absolute text-lg font-bold text-slate-800" id="global-score-text">--</span>
                </div>
            </div>

            <div class="w-full h-40 mb-6 relative"><canvas id="scoreChart"></canvas></div>

            <div class="grid gap-3 flex-grow" id="cards-container"></div>
        </div>
    </div>

    <script>
        // --- STATE VARIABLES ---
        let map;
        let selectedAddress = null;
        let poiData = { transport: [], commerce: [], education: [], health: [], nature: [] };
        // New structure for Real Estate Data: Global price + Year history
        let realEstateData = { 
            globalPrice: 0, 
            history: [] // Array of { year: 2024, price: 4500, count: 12 }
        };
        let typology = "T3";
        let clickCount = 0;
        let clickTimer;
        let searchRadiusLabel = "500m";
        
        // --- INDEXED DB ENGINE ---
        const DB_NAME = 'NeighborScoreDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'dvf_chunks';

        let globalDvfStore = [];

        const dbPromise = new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject(event.target.error);
        });

        async function loadDataFromDB() {
            const db = await dbPromise;
            return new Promise((resolve) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const chunks = request.result; 
                    globalDvfStore = chunks.flatMap(c => c.data);
                    updateStatsUI();
                    resolve(true);
                };
                request.onerror = () => resolve(false);
            });
        }

        async function saveDataToDB(newRows) {
            const db = await dbPromise;
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                store.add({ data: newRows });
                transaction.oncomplete = () => {
                    globalDvfStore = globalDvfStore.concat(newRows);
                    updateStatsUI();
                    resolve();
                };
                transaction.onerror = () => reject();
            });
        }

        async function clearDatabase() {
            if(!confirm("Voulez-vous vraiment effacer toutes les données sauvegardées ?")) return;
            const db = await dbPromise;
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            transaction.objectStore(STORE_NAME).clear();
            globalDvfStore = [];
            updateStatsUI();
            alert("Base de données vidée.");
        }

        function updateStatsUI() {
            const count = globalDvfStore.length;
            const fmt = count.toLocaleString();
            document.getElementById('stat-total-lines').innerText = fmt;
            const statusDiv = document.getElementById('db-status-msg');
            const statusText = document.getElementById('db-count-display');
            if (count > 0) {
                statusDiv.classList.remove('hidden');
                statusText.innerText = `${fmt} LIGNES EN MÉMOIRE (PERSISTANT)`;
            } else {
                statusDiv.classList.add('hidden');
            }
        }

        window.addEventListener('DOMContentLoaded', () => {
            loadDataFromDB().then(() => console.log("DB Loaded:", globalDvfStore.length));
        });

        // --- ADMIN UI ---
        function handleSecretClick() {
            clickCount++;
            clearTimeout(clickTimer);
            clickTimer = setTimeout(() => { clickCount = 0; }, 2000); 
            if (clickCount >= 5) {
                document.getElementById('admin-panel').classList.add('open');
                clickCount = 0;
            }
        }

        function closeAdmin() { document.getElementById('admin-panel').classList.remove('open'); }

        async function handleBatchUpload(files) {
            if (!files || files.length === 0) return;
            const label = document.getElementById('admin-upload-btn');
            const originalText = label.innerHTML;
            
            label.classList.remove('bg-indigo-600');
            label.classList.add('bg-amber-600', 'animate-pulse');
            let totalAdded = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                label.innerHTML = `<i class="fa-solid fa-spinner fa-spin mr-1"></i> TRAITEMENT ${i+1}/${files.length}`;
                try {
                    const rows = await parseFile(file);
                    if (rows && rows.length > 0) {
                        await saveDataToDB(rows);
                        totalAdded += rows.length;
                    }
                } catch (e) {
                    console.error(e);
                    alert("Erreur " + file.name + ": " + e.message);
                }
            }
            label.innerHTML = `<i class="fa-solid fa-check mr-1"></i> AJOUTÉ +${totalAdded.toLocaleString()}`;
            label.classList.remove('bg-amber-600', 'animate-pulse');
            label.classList.add('bg-emerald-600');
            setTimeout(() => {
                label.innerHTML = originalText;
                label.classList.remove('bg-emerald-600');
                label.classList.add('bg-indigo-600');
            }, 3000);
        }

        // --- FILE PARSER ---
        function parseFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                const isGzip = file.name.toLowerCase().endsWith('.gz');

                reader.onload = function(e) {
                    try {
                        let binaryData;
                        if (isGzip) {
                            try {
                                const compressed = new Uint8Array(e.target.result);
                                binaryData = pako.inflate(compressed);
                            } catch (err) { throw new Error("Erreur GZIP"); }
                        } else {
                            binaryData = new Uint8Array(e.target.result);
                        }
                        
                        const rows = [];
                        const decoder = new TextDecoder('utf-8');
                        const CHUNK_SIZE = 5 * 1024 * 1024;
                        let offset = 0;
                        let remainder = '';
                        let isFirstChunk = true;
                        let indices = null;
                        let sep = ',';

                        while (offset < binaryData.length) {
                            const end = Math.min(offset + CHUNK_SIZE, binaryData.length);
                            const chunk = binaryData.subarray(offset, end);
                            const textChunk = decoder.decode(chunk, { stream: true });
                            const currentBlock = remainder + textChunk;
                            const lines = currentBlock.split('\n');
                            
                            if (end < binaryData.length) remainder = lines.pop(); 
                            else remainder = ''; 

                            for (let i = 0; i < lines.length; i++) {
                                const line = lines[i].trim();
                                if (!line) continue;

                                if (isFirstChunk) {
                                    const possibleSeps = [',', '|', ';', '\t'];
                                    let maxCols = 0;
                                    possibleSeps.forEach(s => {
                                        if (line.split(s).length > maxCols) { maxCols = line.split(s).length; sep = s; }
                                    });
                                    const headerRow = line.toLowerCase().split(sep).map(h => h.trim().replace(/"/g, ''));
                                    const find = (k) => headerRow.findIndex(h => k.some(x => h.includes(x)));

                                    indices = {
                                        val: find(['valeur_fonciere', 'valeur', 'prix']),
                                        surf: find(['surface_reelle_bati', 'surface']),
                                        lat: find(['latitude', 'lat']),
                                        lon: find(['longitude', 'lon']),
                                        type: find(['type_local', 'type']),
                                        date: find(['date_mutation', 'date'])
                                    };

                                    if (indices.val < 0 || indices.lat < 0) return resolve([]); 
                                    isFirstChunk = false;
                                    continue; 
                                }

                                const r = line.split(sep);
                                if (r.length < 3) continue;

                                const pf = (idx) => idx > -1 && r[idx] ? parseFloat(r[idx].replace(/"/g,'').replace(',','.')) : NaN;
                                
                                const lat = pf(indices.lat);
                                const lon = pf(indices.lon);
                                const val = pf(indices.val);
                                const surf = pf(indices.surf);
                                
                                let year = 0;
                                if (indices.date > -1 && r[indices.date]) {
                                    const dStr = r[indices.date].replace(/"/g, '');
                                    if (dStr.includes('/')) {
                                        const parts = dStr.split('/');
                                        if (parts.length === 3) year = parseInt(parts[2]);
                                    } else {
                                        year = parseInt(dStr.substring(0, 4));
                                    }
                                }

                                if (!isNaN(lat) && !isNaN(lon) && !isNaN(val) && val > 1000) {
                                    rows.push({
                                        lat: parseFloat(lat.toFixed(5)),
                                        lon: parseFloat(lon.toFixed(5)),
                                        p: Math.round(val),
                                        a: Math.round(surf || 0),
                                        y: year || 0
                                    });
                                }
                            }
                            offset += CHUNK_SIZE;
                        }
                        resolve(rows);
                    } catch(err) { reject(err); }
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // --- SEARCH LOGIC ---
        const input = document.getElementById('address-input');
        const resultsList = document.getElementById('autocomplete-list');

        input.addEventListener('input', async (e) => {
            const query = e.target.value;
            if (query.length < 3) { resultsList.style.display = 'none'; return; }
            try {
                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                resultsList.innerHTML = '';
                if (data.features?.length > 0) {
                    resultsList.style.display = 'block';
                    data.features.forEach(feature => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item text-sm flex items-center';
                        div.innerHTML = `<i class="fa-solid fa-location-dot text-slate-300 mr-3"></i> <div><div class="font-semibold text-slate-700">${feature.properties.label}</div><div class="text-xs text-slate-400">${feature.properties.context}</div></div>`;
                        div.onclick = () => selectAddress(feature);
                        resultsList.appendChild(div);
                    });
                }
            } catch(e) {}
        });

        function selectAddress(feature) {
            input.value = feature.properties.label;
            resultsList.style.display = 'none';
            selectedAddress = {
                label: feature.properties.label,
                lat: feature.geometry.coordinates[1],
                lon: feature.geometry.coordinates[0],
                city: feature.properties.city
            };
        }

        // --- ORCHESTRATOR ---
        async function startAnalysis() {
            if (!selectedAddress) { alert("Veuillez choisir une adresse."); return; }
            
            document.getElementById('landing-page').classList.add('hidden');
            document.getElementById('loading-screen').classList.remove('hidden');
            document.getElementById('loading-content').classList.remove('hidden');
            document.getElementById('error-content').classList.add('hidden');

            realEstateData = { globalPrice: 0, history: [] };

            updateStep(1, "waiting");
            const poiSuccess = await fetchPOIData(selectedAddress.lat, selectedAddress.lon);
            if (!poiSuccess) { showError("OSM"); return; }
            calculateTypology();
            updateStep(1, "done");

            updateStep(2, "waiting");
            
            let hasData = false;
            let source = "API";
            
            if (globalDvfStore.length > 0) {
                source = "LOCAL";
                document.getElementById('loading-text').innerText = `Recherche dans la base locale (${globalDvfStore.length} lignes)...`;
                await new Promise(r => setTimeout(r, 500)); 
                hasData = processLocalDataSmart(selectedAddress.lat, selectedAddress.lon);
            } else {
                hasData = await fetchRealEstateData(selectedAddress.lat, selectedAddress.lon);
            }
            
            if (hasData) {
                updateStep(2, "done");
                updateStep(3, "waiting");
                const scores = calculateScores();
                updateStep(3, "done");
                await new Promise(r => setTimeout(r, 500));
                showDashboard(scores);
            } else {
                showError("NODATA", source);
            }
        }

        function resetApp() { location.reload(); }
        function retryAnalysis() { startAnalysis(); }
        
        function showError(type, source) {
            document.getElementById('loading-content').classList.add('hidden');
            document.getElementById('error-content').classList.remove('hidden');
            
            if (source === "LOCAL") {
                document.getElementById('error-message').innerText = "Aucune transaction trouvée dans la base locale pour cette zone.";
                document.getElementById('local-data-hint').classList.remove('hidden');
                document.getElementById('hint-count').innerText = globalDvfStore.length.toLocaleString();
            } else {
                document.getElementById('error-message').innerText = "API indisponible et base locale vide.";
                document.getElementById('local-data-hint').classList.add('hidden');
            }
        }

        function updateStep(num, status) {
            const el = document.getElementById(`step-${num}`);
            const icon = document.getElementById(`icon-${num}`);
            if (status === "done") {
                el.classList.remove('text-slate-400'); el.classList.add('text-emerald-600', 'font-semibold');
                icon.className = "fa-solid fa-check-circle";
            } else if (status === "waiting") {
                el.classList.add('text-blue-600');
                icon.className = "fa-solid fa-circle-notch fa-spin";
            }
        }

        // --- DATA PROCESSING ---
        async function fetchPOIData(lat, lon) {
            const radius = 800;
            const query = `[out:json][timeout:25];(
                node["amenity"~"school|college|kindergarten|pharmacy|bank|doctors|clinic|cafe|restaurant"](around:${radius},${lat},${lon});
                node["shop"~"supermarket|bakery|convenience|butcher"](around:${radius},${lat},${lon});
                node["highway"="bus_stop"](around:${radius},${lat},${lon});
                node["railway"~"station|subway_entrance|tram_stop"](around:${radius},${lat},${lon});
                node["leisure"~"park|garden"](around:${radius},${lat},${lon});
            );out center;`;
            try {
                const res = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: "data=" + encodeURIComponent(query) });
                if (!res.ok) throw new Error("OSM Error");
                const data = await res.json();
                poiData = { transport: [], commerce: [], education: [], health: [], nature: [] };
                data.elements.forEach(el => {
                    const item = { lat: el.lat||el.center.lat, lon: el.lon||el.center.lon, name: el.tags.name||"Lieu", type: el.tags.amenity||el.tags.shop||el.tags.highway||"Autre" };
                    if(['school','college','kindergarten'].some(t=>item.type.includes(t))) poiData.education.push(item);
                    else if(el.tags.shop || ['bank','cafe','restaurant'].some(t=>item.type.includes(t))) poiData.commerce.push(item);
                    else if(['bus_stop','station','tram_stop'].some(t=>item.type.includes(t))) poiData.transport.push(item);
                    else if(['doctors','pharmacy','clinic'].some(t=>item.type.includes(t))) poiData.health.push(item);
                    else if(el.tags.leisure) poiData.nature.push(item);
                });
                return true;
            } catch (e) { return false; }
        }

        async function fetchRealEstateData(lat, lon) {
            try {
                const controller = new AbortController();
                setTimeout(() => controller.abort(), 5000);
                const res = await fetch(`https://corsproxy.io/?${encodeURIComponent(`https://api.cquest.org/dvf?lat=${lat}&lon=${lon}&dist=500`)}`, { signal: controller.signal });
                if (res.ok) {
                    const data = await res.json();
                    if (data.features) {
                        const items = data.features.map(f => ({
                            p: f.properties.valeur_fonciere,
                            a: f.properties.surface_reelle_bati,
                            y: new Date(f.properties.date_mutation).getFullYear()
                        }));
                        processDvfFeatures(items);
                        searchRadiusLabel = "500m";
                        return (realEstateData.globalPrice > 0);
                    }
                }
            } catch (e) { console.warn("API Fail"); }
            return false;
        }

        // SMART RADIUS LOGIC (EXTENDED TO 5KM)
        function processLocalDataSmart(lat, lon) {
            const steps = [
                { r: 0.005, label: "500m" },
                { r: 0.01, label: "1km" },
                { r: 0.03, label: "3km" },
                { r: 0.05, label: "5km" }
            ];

            for (let step of steps) {
                const local = globalDvfStore.filter(p => Math.abs(p.lat - lat) < step.r && Math.abs(p.lon - lon) < step.r);
                processDvfFeatures(local);
                
                if (realEstateData.globalPrice > 0) {
                    searchRadiusLabel = step.label; 
                    return true;
                }
            }
            return false;
        }

        function processDvfFeatures(items) {
            realEstateData = { globalPrice: 0, history: [] }; 
            let totalSum = 0;
            let totalArea = 0;
            const yearlyStats = {}; 

            items.forEach(i => {
                if(i.p > 10000 && i.a > 9) {
                    const ppms = i.p / i.a;
                    if(ppms < 500 || ppms > 25000) return;
                    
                    const currentYear = new Date().getFullYear();
                    // Take last 4 years for robustness
                    if (i.y >= currentYear - 4) {
                        // Calc global avg on last 3 years
                        if (i.y >= currentYear - 3) {
                            totalSum += i.p;
                            totalArea += i.a;
                        }
                        
                        if (!yearlyStats[i.y]) yearlyStats[i.y] = { sum: 0, area: 0, count: 0 };
                        yearlyStats[i.y].sum += i.p;
                        yearlyStats[i.y].area += i.a;
                        yearlyStats[i.y].count++;
                    }
                }
            });

            if (totalArea > 0) {
                realEstateData.globalPrice = Math.round(totalSum / totalArea);
            }

            const history = Object.keys(yearlyStats).map(y => {
                const d = yearlyStats[y];
                return {
                    year: parseInt(y),
                    price: d.area > 0 ? Math.round(d.sum / d.area) : 0,
                    count: d.count
                };
            }).sort((a, b) => b.year - a.year); 

            realEstateData.history = history;
        }

        // --- RENDER & CHARTS ---
        function calculateTypology() {
            const total = poiData.transport.length + poiData.commerce.length + poiData.education.length;
            if (total > 50) typology = "T1";
            else if (total > 25) typology = "T2";
            else if (total > 8) typology = "T3";
            else typology = "T4";
            document.getElementById('typology-badge').innerText = typology;
        }

        function calculateScores() {
            const score = (val, max) => Math.min(10, Math.round((val/max)*10));
            let t = { tr: 15, co: 20, ed: 6, he: 6 }; 
            if(typology === 'T2') t = { tr: 10, co: 12, ed: 4, he: 4 };
            if(typology === 'T3') t = { tr: 3, co: 5, ed: 2, he: 2 };
            if(typology === 'T4') t = { tr: 1, co: 2, ed: 1, he: 1 };
            return {
                transport: score(poiData.transport.length, t.tr),
                commerce: score(poiData.commerce.length, t.co),
                education: score(poiData.education.length, t.ed),
                health: score(poiData.health.length, t.he)
            };
        }

        function showDashboard(scores) {
            document.getElementById('loading-screen').classList.add('hidden');
            const dash = document.getElementById('dashboard');
            dash.classList.remove('hidden');
            setTimeout(() => dash.classList.remove('opacity-0'), 50);
            document.getElementById('result-address').innerText = selectedAddress.label;
            document.getElementById('radius-badge').innerText = searchRadiusLabel;

            if(map) map.remove();
            map = L.map('map', {zoomControl:false}).setView([selectedAddress.lat, selectedAddress.lon], 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            L.control.zoom({position:'bottomright'}).addTo(map);
            L.marker([selectedAddress.lat, selectedAddress.lon], { icon: L.divIcon({html:'<div style="background:#0f172a;width:16px;height:16px;border:2px solid white;border-radius:50%;"></div>'}) }).addTo(map);

            const draw = (list, col, name) => list.forEach(p => {
                L.circleMarker([p.lat, p.lon], {radius:5, fillColor:col, color:'white', weight:1, fillOpacity:0.9}).addTo(map);
            });
            draw(poiData.transport, '#3b82f6', 'TRANSPORT');
            draw(poiData.commerce, '#fbbf24', 'COMMERCE');
            draw(poiData.education, '#10b981', 'EDUCATION');
            draw(poiData.health, '#f43f5e', 'SANTE');

            renderMarketData();

            const avg = ((scores.transport+scores.commerce+scores.education+scores.health)/4).toFixed(1);
            document.getElementById('global-score-text').innerText = avg;
            document.getElementById('global-label').innerText = avg > 8 ? "Excellent" : avg > 6 ? "Très bon" : avg > 4 ? "Correct" : "Faible";
            setTimeout(() => document.getElementById('global-score-circle').style.strokeDashoffset = 175-(avg/10)*175, 500);

            new Chart(document.getElementById('scoreChart'), {
                type: 'radar',
                data: { labels: ['Mobilité', 'Vie Locale', 'Éducation', 'Santé'], datasets: [{ label: 'Score', data: [scores.transport, scores.commerce, scores.education, scores.health], backgroundColor: 'rgba(79, 70, 229, 0.2)', borderColor: '#4f46e5', pointBackgroundColor: '#fff' }] },
                options: { scales: { r: { min: 0, max: 10, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false }
            });

            document.getElementById('cards-container').innerHTML = `
                ${createCard('Mobilité', scores.transport, poiData.transport.length, 'blue', 'fa-bus')}
                ${createCard('Vie Locale', scores.commerce, poiData.commerce.length, 'amber', 'fa-shop')}
                ${createCard('Éducation', scores.education, poiData.education.length, 'emerald', 'fa-graduation-cap')}
                ${createCard('Santé', scores.health, poiData.health.length, 'rose', 'fa-heart-pulse')}
            `;
        }

        function renderMarketData() {
            const badge = document.getElementById('data-source-badge');
            const disc = document.getElementById('data-meta-info');
            
            // Badge Update
            if (globalDvfStore.length > 0) {
                badge.innerText = "Source: BDD LOCALE (" + searchRadiusLabel + ")";
                badge.className = "text-[9px] px-2 py-0.5 rounded bg-indigo-500/20 border border-indigo-500/30 text-indigo-300";
            } else if (realEstateData.globalPrice > 0) {
                badge.innerText = "Source: DVF (API)";
                badge.className = "text-[9px] px-2 py-0.5 rounded bg-emerald-500/20 border border-emerald-500/30 text-emerald-300";
            } else {
                badge.innerText = "Source: AUCUNE";
                badge.className = "text-[9px] px-2 py-0.5 rounded bg-slate-800 text-slate-500 border border-slate-600";
            }

            // Animated Counter for Price
            const globalP = realEstateData.globalPrice;
            const priceEl = document.getElementById('price-global');
            
            if (globalP > 0) {
                let start = 0;
                const duration = 1500;
                const startTime = performance.now();
                
                function update(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const ease = 1 - Math.pow(1 - progress, 3); // Cubic ease out
                    
                    const currentVal = Math.round(start + (globalP - start) * ease);
                    priceEl.innerText = currentVal.toLocaleString('fr-FR');
                    
                    if (progress < 1) requestAnimationFrame(update);
                }
                requestAnimationFrame(update);
            } else {
                priceEl.innerText = "N/A";
            }

            // Trends Visualization
            const barsContainer = document.getElementById('trend-bars');
            const summary = document.getElementById('trend-summary');
            barsContainer.innerHTML = '';
            
            const hist = realEstateData.history;
            if (hist.length > 0) {
                const yearsToShow = hist.slice(0, 4); // Show up to 4 bars
                const maxP = Math.max(...yearsToShow.map(h => h.price)) || 1;

                // Create Bars (Chronological order: Reverse the sorted array)
                [...yearsToShow].reverse().forEach((h, i) => {
                    const heightPct = Math.max(10, Math.round((h.price / maxP) * 100)); // Min 10% height
                    
                    const barGroup = document.createElement('div');
                    barGroup.className = "flex-1 flex flex-col justify-end group relative cursor-pointer";
                    barGroup.style.height = "100%";
                    
                    // Tooltip
                    const tooltip = `<div class="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] py-1 px-2 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20 pointer-events-none">${h.year}: ${h.price.toLocaleString()}€</div>`;
                    
                    // Bar
                    const bar = document.createElement('div');
                    bar.className = "w-full bg-indigo-400/30 hover:bg-indigo-400/60 rounded-t transition-all duration-300 bar-anim";
                    // Add delay based on index for staggering effect
                    bar.style.height = "0%"; // Start at 0 for anim
                    
                    barGroup.innerHTML = tooltip;
                    barGroup.appendChild(bar);
                    barsContainer.appendChild(barGroup);

                    // Trigger anim after append
                    setTimeout(() => { bar.style.height = `${heightPct}%`; }, i * 150);
                });

                // Summary Text
                const last = yearsToShow[0]; // Most recent
                const first = yearsToShow[yearsToShow.length-1]; // Oldest displayed
                if (last && first && last !== first) {
                    const diff = last.price - first.price;
                    const pct = ((diff/first.price)*100).toFixed(1);
                    const color = diff >= 0 ? 'text-emerald-400' : 'text-rose-400';
                    const icon = diff >= 0 ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down';
                    summary.innerHTML = `<span class="text-slate-400">Tend. ${first.year}-${last.year}</span> <span class="${color} font-bold ml-2"><i class="fa-solid ${icon}"></i> ${diff>0?'+':''}${pct}%</span>`;
                } else {
                    summary.innerHTML = `<span class="text-slate-400">Données ${last.year}</span>`;
                }

            } else {
                barsContainer.innerHTML = '<div class="w-full h-full flex items-center justify-center text-[10px] text-slate-500 italic">Pas d\'historique</div>';
                summary.innerHTML = '';
            }
        }

        function createCard(title, score, count, color, icon) {
            const colors = { blue: 'text-blue-600 bg-blue-100', amber: 'text-amber-600 bg-amber-100', emerald: 'text-emerald-600 bg-emerald-100', rose: 'text-rose-600 bg-rose-100' };
            const textCols = { blue: 'text-blue-600', amber: 'text-amber-500', emerald: 'text-emerald-600', rose: 'text-rose-500' };
            return `<div class="p-3 rounded-xl border border-slate-100 bg-slate-50 flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full ${colors[color]} flex items-center justify-center text-xs"><i class="fa-solid ${icon}"></i></div><div><h4 class="font-bold text-slate-700 text-sm">${title}</h4><p class="text-[10px] text-slate-400">${count} points d'intérêt</p></div></div><span class="text-lg font-bold ${textCols[color]}">${score}/10</span></div>`;
        }
    </script>
</body>
</html>